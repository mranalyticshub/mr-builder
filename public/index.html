<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>MR Analytics Hub – Dashboard Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --gap:16px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; color:#111;}
    .wrap { max-width: 1240px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 16px; }
    .muted { color:#666; font-size:12px; }
    .row { display:flex; align-items:center; gap:12px; }
    .sid-badge { background:#f6f6f6; border:1px solid #e7e7e7; padding:6px 8px; border-radius:6px; font-size:12px; }
    .card { border:1px solid #eee; padding:16px; border-radius:10px; background:#fff; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .toolbar { display:flex; gap:8px; align-items:center; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; z-index:1;}
    .scroll { max-height: 360px; overflow:auto; border:1px solid #f2f2f2; border-radius:8px;}
    iframe { border:1px solid #eee; width:100%; height: 760px; border-radius:10px; }
    .step { margin-bottom: 20px; }
    .hidden { display:none; }
    input[type="text"], select, textarea { width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;}
    textarea { resize:vertical; }
    .pill {padding:2px 8px;border:1px solid #ddd;border-radius:10px;background:#fafafa;font-size:12px;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:8px">
    <h1 style="flex:1">Dashboard Builder</h1>
    <span class="muted">Session:</span><span id="sidBadge" class="sid-badge">–</span>
  </div>

  <!-- STEP A: Profile & Upload -->
  <div class="card step" id="stepA">
    <h2>1) Describe your business or upload a sample</h2>
    <textarea id="prompt" rows="5" placeholder="Tell us briefly about your business and what you want to track (e.g. 'UK sportswear retailer; monthly sales & profit, top brands, returns rate, online vs store')"></textarea>
    <div class="toolbar" style="margin-top:8px">
      <input id="file" type="file" accept=".csv"/>
      <button id="start">Profile dataset</button>
    </div>
    <div id="aMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- STEP B: Review fields & questions -->
  <div class="card step hidden" id="stepB">
    <div class="grid-2">
      <div>
        <h2>2) Fields & meanings</h2>
        <div class="scroll">
          <table id="schemaTable">
            <thead>
              <tr>
                <th style="width:28%">Field</th>
                <th style="width:16%">Type</th>
                <th style="width:20%">Allowed</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <small class="muted">Edit the AI’s guesses. “Allowed” accepts things like <span class="pill">any integer</span> <span class="pill">any positive number</span> <span class="pill">string</span> <span class="pill">string from list</span> etc.</small>
      </div>
      <div>
        <h2>Questions</h2>
        <div id="qBox" class="scroll" style="padding:8px"></div>
        <small class="muted">Please answer any required questions before continuing.</small>
      </div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button id="toDesign">Continue to design</button>
      <div id="bMsg" class="muted"></div>
    </div>
  </div>

  <!-- STEP C: Design & Preview (full width) -->
  <div class="card step hidden" id="stepC">
    <h2>3) Design & Preview</h2>
    <div class="toolbar" style="margin-bottom:8px">
      <input id="nl" placeholder="e.g., add a line of daily orders; split sales by channel; move KPI top-left"/>
      <button id="applyNl">Apply change</button>
      <span id="cMsg" class="muted"></span>
    </div>
    <iframe id="preview" src=""></iframe>

    <div class="grid-2" style="margin-top:16px">
      <div class="card">
        <h3>Approve & continue</h3>
        <input id="company" placeholder="Company name"/>
        <input id="email" placeholder="Contact email"/>
        <button id="approve">Send to MR Analytics</button>
        <div id="plan" class="muted" style="margin-top:8px"></div>
      </div>
      <div class="card">
        <h3>Download spec</h3>
        <button id="downloadSpec">Download schema + DSL (JSON)</button>
      </div>
    </div>
  </div>
</div>

<script>
/** SET THESE TWO CONSTANTS **/
const ORCH    = "https://mr-orchestrator-585407302606.europe-west2.run.app";  // orchestrator base
const PREVIEW = "https://mr-preview-585407302606.europe-west2.run.app";       // preview base

let sid = null;
let schemaTable = [];     // array of rows: {field, dtype, allowed, description}
let questions   = [];     // array: {id, prompt, kind, options?, required?}

/* Utilities */
function setMsg(id, text){ document.getElementById(id).textContent = text || ""; }
function show(id, flag){ document.getElementById(id).classList.toggle("hidden", !flag); }
function setBusy(btn, on, busy="Working…"){ if(!btn) return; btn.disabled=!!on; if(on){ btn.dataset._t=btn.textContent; btn.textContent=busy;} else if(btn.dataset._t){ btn.textContent=btn.dataset._t; } }
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

/* Session bootstrap (cookie is set by the server) */
async function ensureSession(){
  if (sid) return sid;
  const promptSeed = ($("#prompt").value||"").trim();
  const r = await fetch(`${ORCH}/session`, {
    method:"POST",
    credentials:"include",
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ prompt: promptSeed })
  });
  const j = await r.json();
  sid = j.sid || j.session_id || j.id;
  $("#sidBadge").textContent = sid || "–";
  return sid;
}

/* Renderers */
function renderSchemaTable(rows){
  const tb = $("#schemaTable tbody");
  tb.innerHTML = "";
  (rows||[]).forEach(r=>{
    const tr = document.createElement("tr");
    tr.dataset.field = r.field;
    tr.innerHTML = `
      <td><strong>${r.field}</strong></td>
      <td>
        <select data-k="dtype">
          ${["string","integer","number","date","datetime","boolean"].map(d=>`<option ${r.dtype===d?"selected":""} value="${d}">${d}</option>`).join("")}
        </select>
      </td>
      <td><input type="text" data-k="allowed" placeholder="any integer | any positive number | string from list..." value="${(r.allowed||"").replace(/"/g,"&quot;")}"/></td>
      <td><input type="text" data-k="description" placeholder="What does this mean in context?" value="${(r.description||"").replace(/"/g,"&quot;")}"/></td>
    `;
    tb.appendChild(tr);
  });
}

function renderQuestions(qs){
  const box = $("#qBox");
  box.innerHTML = "";
  (qs||[]).forEach(q=>{
    const wrap = document.createElement("div");
    wrap.style.marginBottom = "10px";
    wrap.innerHTML = `<div style="margin-bottom:4px"><strong>${q.prompt||q.id}</strong>${q.required? ' <span class="pill">required</span>':''}</div>`;
    let el;
    if ((q.kind||"").toLowerCase() === "select") {
      el = document.createElement("select");
      (q.options||[]).forEach(opt=>{
        const o = document.createElement("option");
        o.value = opt; o.textContent = opt; el.appendChild(o);
      });
      if (q.default) el.value = q.default;
    } else {
      el = document.createElement("input");
      el.type = "text";
      el.placeholder = q.placeholder || "";
      if (q.default) el.value = q.default;
    }
    el.dataset.qid = q.id;
    el.style.width = "100%";
    wrap.appendChild(el);
    box.appendChild(wrap);
  });
}

/* Collectors */
function collectSchemaEdits(){
  const rows = $$("#schemaTable tbody tr");
  return rows.map(tr=>{
    const field = tr.dataset.field;
    const out = { field };
    tr.querySelectorAll("[data-k]").forEach(el => out[el.dataset.k] = el.value.trim());
    return out;
  });
}

function collectAnswers(){
  const ans = {};
  $$("#qBox [data-qid]").forEach(el => ans[el.dataset.qid] = el.value.trim());
  return ans;
}

/* Actions */
$("#start").onclick = async () => {
  const btn = $("#start");
  setBusy(btn, true, "Profiling…");
  setMsg("aMsg", "");
  try {
    await ensureSession();

    const fd = new FormData();
    fd.append("prompt", ($("#prompt").value||"").trim());
    const file = $("#file").files[0]; if (file) fd.append("file", file);

    const r = await fetch(`${ORCH}/profile/${encodeURIComponent(sid)}`, {
      method:"POST", body: fd, credentials:"include"
    });
    const j = await r.json();

    if (!j || j.ok === false) throw new Error(j?.error || "Profile failed");

    schemaTable = j.schema_table || [];
    questions   = j.questions    || [];
    renderSchemaTable(schemaTable);
    renderQuestions(questions);

    show("stepB", true);
    setMsg("aMsg","Profiling complete. Review fields and answer questions.");
    $("#stepB").scrollIntoView({behavior:"smooth"});
  } catch (e){
    console.error(e);
    setMsg("aMsg", "Profiling failed. Check logs.");
  } finally {
    setBusy(btn, false);
  }
};

$("#toDesign").onclick = async () => {
  const btn = $("#toDesign");
  setBusy(btn, true, "Designing…");
  setMsg("bMsg", "");
  try {
    const edited = collectSchemaEdits();
    const answers = collectAnswers();

    const r = await fetch(`${ORCH}/design/${encodeURIComponent(sid)}`, {
      method:"POST",
      credentials:"include",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ schema_table: edited, answers })
    });
    const j = await r.json();
    if (!j || j.ok === false) throw new Error(j?.error || "Design failed");

    const url = `${PREVIEW}/?sid=${encodeURIComponent(sid)}&_=${Date.now()}`;
    $("#preview").src = url;
    show("stepC", true);
    $("#stepC").scrollIntoView({behavior:"smooth"});
  } catch (e){
    console.error(e);
    setMsg("bMsg", "Design failed. Check logs.");
  } finally {
    setBusy(btn, false);
  }
};

$("#applyNl").onclick = async () => {
  const btn = $("#applyNl");
  setBusy(btn, true, "Applying…");
  setMsg("cMsg", "");
  try{
    const change = ($("#nl").value||"").trim();
    if (!change) { setBusy(btn,false); return; }
    await fetch(`${ORCH}/edit/${encodeURIComponent(sid)}`, {
      method:"POST",
      credentials:"include",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ change })
    });
    // Simply reload preview
    $("#preview").src = `${PREVIEW}/?sid=${encodeURIComponent(sid)}&_=${Date.now()}`;
  } catch(e){
    console.error(e);
    setMsg("cMsg","Couldn’t apply change.");
  } finally {
    setBusy(btn, false);
  }
};

$("#approve").onclick = async () => {
  const email = ($("#email").value||"").trim();
  const company = ($("#company").value||"").trim();
  if(!email || !company) return alert("Company and email required");
  try{
    const r = await fetch(`${ORCH}/export/${encodeURIComponent(sid)}`, {
      method:"POST",
      credentials:"include",
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ client_email: email, company })
    });
    const j = await r.json();
    $("#plan").innerHTML = j?.ok ? "Sent. We'll be in touch shortly." : (j?.error || "Failed to send.");
  } catch(e){
    console.error(e);
    $("#plan").textContent = "Failed to send.";
  }
};

$("#downloadSpec").onclick = async () => {
  try{
    const r = await fetch(`${ORCH}/artifacts?sid=${encodeURIComponent(sid)}`, { credentials:"include" });
    const data = await r.json();
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = `mr_draft_${sid}.json`; a.click();
  }catch(e){ console.error(e); }
};
</script>
</body>
</html>