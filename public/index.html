<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>MR Analytics Hub – Dashboard Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --gap:16px; }
    html, body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; color:#111;}
    .wrap { max-width: 1240px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 16px; font-size: 38px; letter-spacing:.2px}
    h2 { margin: 0 0 10px; }
    .muted { color:#666; font-size:13px; }
    .row { display:flex; align-items:center; gap:12px; }
    .sid-badge { background:#fafafa; border:1px solid #e7e7e7; padding:6px 8px; border-radius:6px; font-size:12px; }
    .card { border:1px solid #eee; padding:16px; border-radius:10px; background:#fff; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button { appearance:none; background:#111; color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#f5f5f5; color:#111; border:1px solid #ddd; }
    button.ghost { background:transparent; color:#111; border:1px dashed #ccc; }
    button[disabled] { opacity:.55; cursor:not-allowed; }
    input[type="text"], input[type="email"], select, textarea { width:100%; padding:9px 10px; border-radius:8px; border:1px solid #ddd; }
    textarea { min-height: 120px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    .hidden { display:none; }
    .err { color:#b00020; }
    .ok { color:#0a6; }

    /* table */
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; border-top:1px solid #eee; padding:10px 12px; vertical-align:top; }
    th { background:#fafafa; border-top:0; position:sticky; top:0; z-index:1; }
    tbody tr:hover { background:#fcfcfc; }
    .fit { width:1%; white-space:nowrap; }
    .pill { font-size:12px; padding:3px 8px; border-radius:999px; background:#f3f4f6; border:1px solid #e5e7eb; }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:8px">
    <h1 style="flex:1">Dashboard Builder</h1>
    <span class="muted">Session:</span>
    <span id="sidBadge" class="sid-badge">–</span>
    <button id="newSession" class="secondary" type="button" title="Start a fresh session">New session</button>
  </div>

  <!-- STEP A -->
  <div class="card" id="stepA">
    <h2>1) Describe your business or upload a sample</h2>
    <textarea id="prompt" placeholder="What’s your business and what should the dashboard show?"></textarea>
    <div class="toolbar" style="margin-top:8px">
      <input id="file" type="file" accept=".csv,.xlsx"/>
      <button id="start" type="button">Profile dataset</button>
      <span id="aMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP B -->
  <div class="card hidden" id="stepB">
    <div class="row" style="justify-content:space-between; align-items:flex-end;">
      <div>
        <h2>2) Field Map</h2>
        <div id="stepBMsg" class="muted"></div>
      </div>
      <div class="row">
        <input id="fieldSearch" type="text" placeholder="Filter fields… (e.g. date, price, region)" style="min-width:260px"/>
        <button id="copyJSON" class="ghost" type="button" title="Copy current field map JSON">Copy JSON</button>
      </div>
    </div>

    <div style="max-height: 420px; overflow: auto; border:1px solid #eee; border-radius:10px; margin-top:10px;">
      <table id="fieldsTable">
        <thead>
          <tr>
            <th class="fit">#</th>
            <th>field</th>
            <th class="fit">dtype</th>
            <th>allowed</th>
            <th style="width:45%">description</th>
          </tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
      </table>
    </div>

    <div style="margin-top:12px" class="muted">Tips: click in the <b>dtype</b>, <b>allowed</b> or <b>description</b> cells to edit. Your changes are saved in the session.</div>
  </div>

  <!-- STEP C -->
  <div class="card hidden" id="stepC" style="margin-top:16px;">
    <h2>3) Questions</h2>
    <div id="qMsg" class="muted"></div>
    <div id="questionsWrap" class="grid-2" style="margin-top:8px;"></div>

    <div class="toolbar" style="margin-top:14px">
      <button id="continueDesign" type="button">Continue to design</button>
      <span id="designMsg" class="muted"></span>
    </div>
  </div>
</div>

<script>
/* ======== CONFIG ======== */
const ORCH = "https://mr-orchestrator-585407302606.europe-west2.run.app";

/* ======== HELPERS ======== */
const $ = (id) => document.getElementById(id);
function setMsg(id, text, cls="muted"){ const el=$(id); if(!el) return; el.className=cls; el.textContent = text||""; }
function show(id, flag){ $(id).classList.toggle("hidden", !flag); }
function setBusy(btn, on, label="Working…"){
  if(!btn) return;
  btn.disabled = !!on;
  if(on){ btn.dataset._t = btn.textContent; btn.textContent = label; }
  else if(btn.dataset._t){ btn.textContent = btn.dataset._t; delete btn.dataset._t; }
}
function readQuery(k){ const p = new URLSearchParams(location.search); return p.get(k); }
function cookieGet(name){ return (`; ${document.cookie}`).split(`; ${name}=`).pop().split(';')[0] || ""; }
function cookieSet(name, value){ document.cookie = `${name}=${value}; Max-Age=3600; Path=/; SameSite=None; Secure`; }
function cookieDel(name){ document.cookie = `${name}=; Max-Age=0; Path=/; SameSite=None; Secure`; }
function pickFields(resp){
  if (Array.isArray(resp?.fields)) return resp.fields;
  if (Array.isArray(resp?.schema_table)) return resp.schema_table;
  if (Array.isArray(resp?.schema)) return resp.schema;
  if (Array.isArray(resp?.field_map?.tables?.[0]?.fields)) return resp.field_map.tables[0].fields;
  return [];
}

/* ======== STATE ======== */
let sid = null;
let FIELD_ROWS = [];     // [{field,dtype,allowed,description}, ...]
let QUESTIONS = [];      // ["...", ...]
let ANSWERS = [];        // synced with inputs

/* ======== SESSION ======== */
async function createSession(){
  let r = await fetch(`${ORCH}/session`, {
    method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({prompt:""})
  });
  if(r.status === 422){ r = await fetch(`${ORCH}/session`, { method:"POST" }); }
  const j = await r.json();
  const newSid = j.sid || j.session_id;
  if(!newSid) throw new Error("No sid in /session response");
  cookieSet("mr_sid", newSid);
  sid = newSid;
  $("sidBadge").textContent = sid;
  return sid;
}
async function ensureSession(){
  if(readQuery("new") === "1"){ cookieDel("mr_sid"); }
  const urlSid = (readQuery("sid") || "").trim();
  const ckSid  = (cookieGet("mr_sid") || "").trim();
  if(urlSid){ sid = urlSid; cookieSet("mr_sid", sid); $("sidBadge").textContent = sid; return sid; }
  if(ckSid){ sid = ckSid; $("sidBadge").textContent = sid; return sid; }
  return await createSession();
}

/* ======== RENDERERS ======== */
function renderFieldsTable(filter=""){
  const tbody = $("fieldsBody");
  tbody.innerHTML = "";
  let rows = FIELD_ROWS;
  if(filter){
    const f = filter.toLowerCase();
    rows = rows.filter(r =>
      (r.field||"").toLowerCase().includes(f) ||
      (r.dtype||"").toLowerCase().includes(f) ||
      (r.allowed||"").toLowerCase().includes(f) ||
      (r.description||"").toLowerCase().includes(f)
    );
  }
  rows.forEach((row, i) => {
    const tr = document.createElement("tr");

    const c0 = document.createElement("td"); c0.className="fit muted"; c0.textContent = i+1; tr.appendChild(c0);

    const c1 = document.createElement("td");
    c1.innerHTML = `<span class="pill">${row.field || ""}</span>`;
    tr.appendChild(c1);

    const c2 = document.createElement("td"); c2.className="fit";
    const dtype = document.createElement("select");
    ["string","category","number","integer","date","datetime","boolean"].forEach(opt=>{
      const o = document.createElement("option"); o.value=opt; o.textContent=opt;
      if((row.dtype||"").toLowerCase()===opt) o.selected=true;
      dtype.appendChild(o);
    });
    dtype.addEventListener("change", (e)=>{ row.dtype = e.target.value; });
    c2.appendChild(dtype);
    tr.appendChild(c2);

    const c3 = document.createElement("td");
    const allowed = document.createElement("input");
    allowed.type="text"; allowed.placeholder="any string / any positive number / string from list [A,B] …";
    allowed.value = row.allowed || "";
    allowed.addEventListener("input", (e)=>{ row.allowed = e.target.value; });
    c3.appendChild(allowed);
    tr.appendChild(c3);

    const c4 = document.createElement("td");
    const desc = document.createElement("textarea");
    desc.value = row.description || "";
    desc.addEventListener("input", (e)=>{ row.description = e.target.value; });
    c4.appendChild(desc);
    tr.appendChild(c4);

    tbody.appendChild(tr);
  });

  $("stepBMsg").textContent =
    `Detected ${FIELD_ROWS.length} fields. Showing ${rows.length}${filter ? ` (filtered)` : ""}.`;
}

function renderQuestions(){
  const wrap = $("questionsWrap");
  wrap.innerHTML = "";
  ANSWERS = QUESTIONS.map(()=> "");
  if(!QUESTIONS.length){
    setMsg("qMsg","No questions returned by the model.","muted");
    return;
  }
  QUESTIONS.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "card";
    div.style.border = "1px dashed #eee";
    div.innerHTML = `
      <div class="muted" style="margin-bottom:6px">Question ${idx+1}</div>
      <div style="font-weight:600; margin-bottom:8px">${q}</div>
      <textarea placeholder="Your answer (optional)" data-idx="${idx}"></textarea>
    `;
    wrap.appendChild(div);
  });
  wrap.querySelectorAll("textarea").forEach(t =>
    t.addEventListener("input", (e)=>{ ANSWERS[e.target.dataset.idx|0] = e.target.value; })
  );
  setMsg("qMsg", `There ${QUESTIONS.length===1 ? "is" : "are"} ${QUESTIONS.length} question${QUESTIONS.length===1?"":"s"}.`);
}

/* ======== ACTIONS ======== */
async function onNewSession(){
  try{
    setBusy($("newSession"), true, "Starting…");
    cookieDel("mr_sid");
    await createSession();
    setMsg("aMsg", "New session started.", "ok");
  }catch(e){
    console.error(e);
    setMsg("aMsg", "Could not start a new session.", "err");
  }finally{
    setBusy($("newSession"), false);
  }
}

async function onProfile(){
  const btn = $("start");
  setBusy(btn, true, "Profiling…");
  setMsg("aMsg", "");
  show("stepB", false);
  show("stepC", false);

  try{
    await ensureSession();

    const fd = new FormData();
    fd.append("prompt", ($("prompt").value || "").toString());
    const f = $("file").files[0];
    if(f) fd.append("file", f);

    const r = await fetch(`${ORCH}/profile/${encodeURIComponent(sid)}`, { method:"POST", body: fd });
    const text = await r.text();
    let data = {};
    try { data = JSON.parse(text || "{}"); } catch { /* keep default */ }

    if(!r.ok){
      console.error("PROFILE ERROR", r.status, text);
      throw new Error(data?.error || text || `HTTP ${r.status}`);
    }

    const fields = pickFields(data);
    FIELD_ROWS = (fields || []).map(x => ({
      field: x.field || x.name || "",
      dtype: (x.dtype || x.type || "string").toLowerCase(),
      allowed: x.allowed || "",
      description: x.description || ""
    }));
    QUESTIONS = Array.isArray(data?.questions) ? data.questions : [];

    if(!FIELD_ROWS.length){
      setMsg("aMsg", "Profiling completed but no fields were detected. Check your file format.", "err");
      return;
    }

    setMsg("aMsg", `Profiling complete. Detected ${FIELD_ROWS.length} fields • ${QUESTIONS.length} question${QUESTIONS.length===1?"":"s"}`, "ok");

    // Fields
    renderFieldsTable("");
    show("stepB", true);

    // Questions
    renderQuestions();
    show("stepC", true);

  }catch(e){
    console.error(e);
    setMsg("aMsg", "Profiling failed. Check logs.", "err");
  }finally{
    setBusy(btn, false);
  }
}

function onFieldSearch(e){
  renderFieldsTable(e.target.value || "");
}

function onCopyJSON(){
  const payload = { schema_table: FIELD_ROWS, questions: QUESTIONS };
  navigator.clipboard.writeText(JSON.stringify(payload, null, 2))
    .then(()=> setMsg("stepBMsg","Copied current field map JSON to clipboard.","ok"))
    .catch(()=> setMsg("stepBMsg","Could not copy to clipboard.","err"));
}

async function onContinueDesign(){
  const btn = $("continueDesign");
  setBusy(btn, true, "Designing…"); setMsg("designMsg","");
  try{
    const body = {
      schema_table: FIELD_ROWS,
      answers: ANSWERS.filter(a=> (a||"").trim() !== "")
    };
    const r = await fetch(`${ORCH}/design/${encodeURIComponent(sid)}`, {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
    });
    const data = await r.json();
    if(!r.ok){ throw new Error(data?.error || `HTTP ${r.status}`); }
    setMsg("designMsg","Design created. (DSL saved in session artifacts.)","ok");
  }catch(e){
    console.error(e);
    setMsg("designMsg","Could not create design. Check logs.","err");
  }finally{
    setBusy(btn, false);
  }
}

/* ======== BOOT ======== */
(async () => {
  try {
    await ensureSession();
  } catch(e) {
    console.error(e);
    setMsg("aMsg", "Could not create a session. Please reload.", "err");
  }
  $("newSession").addEventListener("click", onNewSession, {passive:true});
  $("start").addEventListener("click", onProfile, {passive:true});
  $("fieldSearch").addEventListener("input", onFieldSearch);
  $("copyJSON").addEventListener("click", onCopyJSON);
  $("continueDesign").addEventListener("click", onContinueDesign);
})();
</script>
</body>
</html>