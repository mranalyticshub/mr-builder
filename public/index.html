<script>
/* -----------------------------
   Config + lightweight state
------------------------------*/
const ORCH = "https://mr-orchestrator-585407302606.europe-west2.run.app";

let sid = null;
let fieldMap = null;
let questions = [];

/* -----------------------------
   Tiny DOM helpers
------------------------------*/
function setMsg(id, text) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = text || "";
}
function show(id, flag) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle("hidden", !flag);
}
function setBusy(btn, on, busyText = "Working…") {
  if (!btn) return;
  btn.disabled = !!on;
  if (on) {
    if (!btn.dataset._label) btn.dataset._label = btn.textContent;
    btn.textContent = busyText;
  } else {
    btn.textContent = btn.dataset._label || btn.textContent;
  }
}

/* -----------------------------
   Session bootstrap
------------------------------*/
async function ensureSession() {
  if (sid) return sid;
  const r = await fetch(`${ORCH}/session`, { method: "POST" });
  if (!r.ok) throw new Error(`/session failed: ${r.status}`);
  // server returns {session_id: "..."} or {sid: "..."} depending on your impl
  const j = await r.json();
  sid = j.session_id || j.sid || j.id;
  if (!sid) throw new Error("No session_id returned by /session");
  const badge = document.getElementById("sidBadge");
  if (badge) badge.textContent = sid;
  return sid;
}

/* -----------------------------
   Field map & questions rendering
------------------------------*/
function renderFieldTable(map) {
  const tb = document.querySelector("#fieldTable tbody");
  if (!tb) return;
  tb.innerHTML = "";

  const fields = (map?.tables?.[0]?.fields) || [];
  for (const f of fields) {
    const tr = document.createElement("tr");
    tr.dataset.field = f.name;

    // normalize to avoid undefined
    const type = f.type || "STRING";
    const sem = f.semantic || "";
    const unit = f.unit || f.grain || "";
    const desc = f.desc || "";

    tr.innerHTML = `
      <td><strong>${f.name}</strong></td>
      <td>
        <select data-k="type">
          <option ${type === "STRING" ? "selected" : ""}>STRING</option>
          <option ${type === "NUMERIC" ? "selected" : ""}>NUMERIC</option>
          <option ${type === "DATE" ? "selected" : ""}>DATE</option>
        </select>
      </td>
      <td>
        <select data-k="semantic">
          <option value="" ${sem === "" ? "selected" : ""}>—</option>
          <option value="id" ${sem === "id" ? "selected" : ""}>id</option>
          <option value="date" ${sem === "date" ? "selected" : ""}>date</option>
          <option value="currency" ${sem === "currency" ? "selected" : ""}>currency</option>
          <option value="category" ${sem === "category" ? "selected" : ""}>category</option>
        </select>
      </td>
      <td><input type="text" data-k="unit" placeholder="GBP, %, day, month" value="${unit}"/></td>
      <td><input type="text" data-k="desc" placeholder="Short explanation" value="${desc}"/></td>
    `;
    tb.appendChild(tr);
  }
}

function renderQuestions(qs) {
  const box = document.getElementById("qBox");
  if (!box) return;
  box.innerHTML = "";

  (qs || []).forEach(q => {
    const wrap = document.createElement("div");
    wrap.style.marginBottom = "12px";
    wrap.innerHTML = `<div><strong>${q.prompt || ""}</strong></div>`;

    let inputEl;
    if ((q.kind || "").toLowerCase() === "select") {
      inputEl = document.createElement("select");
      (q.options || []).forEach(o => {
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        inputEl.appendChild(opt);
      });
      if (q.default) inputEl.value = q.default;
    } else {
      inputEl = document.createElement("input");
      inputEl.type = "text";
      inputEl.placeholder = q.placeholder || "";
      if (q.default) inputEl.value = q.default;
    }
    inputEl.dataset.qid = q.id;
    inputEl.style.width = "100%";
    wrap.appendChild(inputEl);
    box.appendChild(wrap);
  });
}

/* -----------------------------
   Collect edits / answers
------------------------------*/
function collectFieldMapEdits() {
  if (!fieldMap?.tables?.[0]) return fieldMap;

  const rows = document.querySelectorAll("#fieldTable tbody tr");
  const byName = {};
  rows.forEach(r => {
    const name = r.dataset.field;
    const out = {};
    r.querySelectorAll("[data-k]").forEach(el => {
      out[el.dataset.k] = (el.value || "").trim();
    });
    byName[name] = out;
  });

  const table = fieldMap.tables[0];
  table.fields = table.fields.map(f => {
    const e = byName[f.name] || {};
    return {
      ...f,
      type: e.type || f.type || "STRING",
      semantic: e.semantic || f.semantic || "",
      unit: e.unit || f.unit,
      grain: e.unit || f.grain,
      desc: e.desc || f.desc || ""
    };
  });
  return fieldMap;
}

function collectAnswers() {
  const inputs = document.querySelectorAll("#qBox [data-qid]");
  const ans = {};
  inputs.forEach(i => ans[i.dataset.qid] = (i.value || "").trim());
  return ans;
}

/* -----------------------------
   Button handlers
------------------------------*/

/* Global fallback the button can call inline if you decide to add:
   onclick="window._start && window._start()" to the button tag.
   Not required if DOMContentLoaded binding works for you.
*/
window._start = async function () {
  const btn = document.getElementById("start");
  try {
    setBusy(btn, true, "Profiling…");
    setMsg("aMsg", "");

    await ensureSession();

    const fd = new FormData();
    fd.append("prompt", (document.getElementById("prompt").value || "").toString());
    const f = document.getElementById("file").files[0];
    if (f) fd.append("file", f);

    const r = await fetch(`${ORCH}/profile/${encodeURIComponent(sid)}`, {
      method: "POST",
      body: fd
    });
    const text = await r.text();
    if (!r.ok) throw new Error(`/profile failed (${r.status}): ${text}`);

    let data = {};
    try { data = JSON.parse(text || "{}"); } catch (_) {}

    fieldMap  = data.field_map || data.fieldMap || {};
    questions = data.questions || [];

    renderFieldTable(fieldMap);
    renderQuestions(questions);

    if (fieldMap?.tables?.[0]?.fields?.length) {
      setMsg("aMsg", "Profiling complete. Review fields and answer questions.");
      show("stepB", true);
      document.getElementById("stepB").scrollIntoView({ behavior: "smooth" });
    } else {
      setMsg("aMsg", "Profiling completed but no fields were detected. Check your file format.");
    }
  } catch (e) {
    console.error(e);
    setMsg("aMsg", "Profiling failed. Check logs.");
  } finally {
    setBusy(btn, false);
  }
};

async function onDesign() {
  const btn = document.getElementById("toDesign");
  try {
    setBusy(btn, true, "Building…");
    setMsg("bMsg", "");

    const fm = collectFieldMapEdits();
    const answers = collectAnswers();

    // Save map first
    await fetch(`${ORCH}/field-map/${encodeURIComponent(sid)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(fm)
    });

    // Build DSL and get preview url
    const r = await fetch(`${ORCH}/design/${encodeURIComponent(sid)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answers })
    });

    const text = await r.text();
    if (!r.ok) throw new Error(`/design failed (${r.status}): ${text}`);

    let data = {};
    try { data = JSON.parse(text || "{}"); } catch (_) {}

    const iframe = document.getElementById("preview");
    const url = data.preview_url || data.url;
    if (!url) {
      setMsg("bMsg", "Design returned no preview URL. Check logs.");
      return;
    }
    iframe.src = url + (url.includes("?") ? "&" : "?") + "_=" + Date.now();

    show("stepC", true);
    document.getElementById("stepC").scrollIntoView({ behavior: "smooth" });
  } catch (e) {
    console.error(e);
    setMsg("bMsg", "Design failed. Check logs.");
  } finally {
    setBusy(btn, false);
  }
}

async function onNlEdit() {
  const btn = document.getElementById("applyNl");
  try {
    setBusy(btn, true, "Applying…");
    const nl = (document.getElementById("nl").value || "").trim();
    const r = await fetch(`${ORCH}/nl-edit/${encodeURIComponent(sid)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ instruction: nl })
    });
    const data = await r.json().catch(() => ({}));
    const url = data.preview_url || data.url;
    if (url) {
      document.getElementById("preview").src = url + (url.includes("?") ? "&" : "?") + "_=" + Date.now();
    } else {
      setMsg("cMsg", "No preview URL returned.");
    }
  } finally {
    setBusy(btn, false);
  }
}

async function onApprove() {
  const company = (document.getElementById("company").value || "").trim();
  const email   = (document.getElementById("email").value || "").trim();
  if (!company || !email) {
    alert("Company and email required");
    return;
  }
  const r = await fetch(`${ORCH}/approve/${encodeURIComponent(sid)}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ company, email })
  });
  const data = await r.json().catch(() => ({}));
  const plan = document.getElementById("plan");
  plan.innerHTML = `<strong>${data.plan || "Trial"}</strong> – ${data.reason || ""}<br>
    ${data.signup_url ? `<a href="${data.signup_url}" target="_blank" rel="noopener">Continue to Sign Up</a>` : ""}`;
}

async function onDownloadSpec() {
  const r = await fetch(`${ORCH}/artifacts?sid=${encodeURIComponent(sid)}`);
  const data = await r.json().catch(() => ({}));
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `mr_draft_${sid || "session"}.json`;
  a.click();
}

/* -----------------------------
   Bind everything safely
------------------------------*/
document.addEventListener("DOMContentLoaded", () => {
  // Buttons
  const startBtn  = document.getElementById("start");
  const toDesign  = document.getElementById("toDesign");
  const applyNl   = document.getElementById("applyNl");
  const approve   = document.getElementById("approve");
  const dlSpec    = document.getElementById("downloadSpec");

  if (startBtn)  startBtn.addEventListener("click", window._start);
  if (toDesign)  toDesign.addEventListener("click", onDesign);
  if (applyNl)   applyNl.addEventListener("click", onNlEdit);
  if (approve)   approve.addEventListener("click", onApprove);
  if (dlSpec)    dlSpec.addEventListener("click", onDownloadSpec);

  console.log("[UI] handlers bound");
});
</script>