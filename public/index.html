<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>MR Analytics Hub – Dashboard Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --gap:16px; }
    html, body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; color:#111;}
    .wrap { max-width: 1240px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 16px; font-size: 38px; letter-spacing:.2px}
    h2 { margin: 0 0 10px; }
    .muted { color:#666; font-size:13px; }
    .row { display:flex; align-items:center; gap:12px; }
    .sid-badge { background:#fafafa; border:1px solid #e7e7e7; padding:6px 8px; border-radius:6px; font-size:12px; }
    .card { border:1px solid #eee; padding:16px; border-radius:10px; background:#fff; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button { appearance:none; background:#111; color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#f5f5f5; color:#111; border:1px solid #ddd; }
    button[disabled] { opacity:.55; cursor:not-allowed; }
    input[type="text"], input[type="email"], select, textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #ddd; }
    textarea { min-height: 140px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    .hidden { display:none; }
    .err { color:#b00020; }
    .ok { color:#0a6; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { text-align:left; border-bottom:1px solid #eee; padding:8px 6px; font-size:14px; }
    th { background:#fafafa; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:8px">
    <h1 style="flex:1">Dashboard Builder</h1>
    <span class="muted">Session:</span>
    <span id="sidBadge" class="sid-badge">–</span>
    <button id="newSession" class="secondary" type="button" title="Start a fresh session">New session</button>
  </div>

  <!-- STEP A -->
  <div class="card" id="stepA">
    <h2>1) Describe your business or upload a sample</h2>
    <textarea id="prompt" placeholder="What’s your business and what should the dashboard show?"></textarea>
    <div class="toolbar" style="margin-top:8px">
      <input id="file" type="file" accept=".csv,.xlsx"/>
      <button id="start" type="button">Profile dataset</button>
      <span id="aMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP B -->
  <div class="card hidden" id="stepB">
    <h2>2) Field Map</h2>
    <div id="stepBMsg" class="muted"></div>
    <div id="fieldsPreview"></div>
  </div>
</div>

<script>
/* ======== CONFIG ======== */
const ORCH = "https://mr-orchestrator-585407302606.europe-west2.run.app";

/* ======== HELPERS ======== */
const $ = (id) => document.getElementById(id);
function setMsg(id, text, cls="muted"){ const el=$(id); if(!el) return; el.className=cls; el.textContent = text||""; }
function show(id, flag){ $(id).classList.toggle("hidden", !flag); }
function setBusy(btn, on, label="Working…"){
  if(!btn) return;
  btn.disabled = !!on;
  if(on){ btn.dataset._t = btn.textContent; btn.textContent = label; }
  else if(btn.dataset._t){ btn.textContent = btn.dataset._t; delete btn.dataset._t; }
}
function readQuery(k){ const p = new URLSearchParams(location.search); return p.get(k); }
function cookieGet(name){
  try{
    const v = (`; ${document.cookie}`).split(`; ${name}=`).pop().split(';')[0];
    return v === document.cookie ? "" : v;
  }catch(_){ return ""; }
}
function cookieSet(name, value){ document.cookie = `${name}=${value}; Max-Age=3600; Path=/; SameSite=None; Secure`; }
function cookieDel(name){ document.cookie = `${name}=; Max-Age=0; Path=/; SameSite=None; Secure`; }

/* Small renderer for a preview table (first 6 rows) */
function renderFieldsPreview(fields){
  const root = $("fieldsPreview");
  root.innerHTML = "";
  if(!Array.isArray(fields) || !fields.length) return;

  const head = document.createElement("div");
  head.className = "muted";
  head.textContent = "Preview of detected fields:";
  root.appendChild(head);

  const tbl = document.createElement("table");
  const thead = document.createElement("thead");
  thead.innerHTML = "<tr><th>field</th><th>dtype</th><th>description</th></tr>";
  tbl.appendChild(thead);

  const tbody = document.createElement("tbody");
  fields.slice(0,6).forEach(f => {
    const tr = document.createElement("tr");
    const field = (f.field ?? f.name ?? "");
    const dtype = (f.dtype ?? f.type ?? "");
    const desc  = (f.description ?? "");
    tr.innerHTML = `<td>${escapeHtml(field)}</td><td>${escapeHtml(dtype)}</td><td>${escapeHtml(desc)}</td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  root.appendChild(tbl);
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"'`=\/]/g, c => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#47;","`":"&#96;","=":"&#61;"
  }[c]));
}

/* ======== STATE ======== */
let sid = null;

/* ======== SESSION ======== */
async function createSession(){
  let r = await fetch(`${ORCH}/session`, {
    method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({prompt:""})
  });
  if(r.status === 422){ r = await fetch(`${ORCH}/session`, { method:"POST" }); }
  const j = await r.json();
  const newSid = j.sid || j.session_id;
  if(!newSid) throw new Error("No sid in /session response");
  cookieSet("mr_sid", newSid);
  sid = newSid;
  $("sidBadge").textContent = sid;
  return sid;
}

async function ensureSession(){
  if(readQuery("new") === "1"){ cookieDel("mr_sid"); }
  const urlSid = (readQuery("sid") || "").trim();
  const ckSid  = (cookieGet("mr_sid") || "").trim();
  if(urlSid){ sid = urlSid; cookieSet("mr_sid", sid); $("sidBadge").textContent = sid; return sid; }
  if(ckSid){ sid = ckSid; $("sidBadge").textContent = sid; return sid; }
  return await createSession();
}

/* ======== WIRES ======== */
async function onNewSession(){
  try{
    setBusy($("newSession"), true, "Starting…");
    cookieDel("mr_sid");
    await createSession();
    setMsg("aMsg", "New session started.", "ok");
    show("stepB", false);
    $("fieldsPreview").innerHTML = "";
    $("stepBMsg").textContent = "";
  }catch(e){
    console.error(e);
    setMsg("aMsg", "Could not start a new session.", "err");
  }finally{
    setBusy($("newSession"), false);
  }
}

function pickFields(resp){
  // Preferred keys first, then legacy
  if (Array.isArray(resp?.fields)) return resp.fields;
  if (Array.isArray(resp?.schema_table)) return resp.schema_table;
  if (Array.isArray(resp?.schema)) return resp.schema;
  if (Array.isArray(resp?.field_map?.tables?.[0]?.fields)) return resp.field_map.tables[0].fields;
  return [];
}

async function onProfile(){
  const btn = $("start");
  setBusy(btn, true, "Profiling…");
  setMsg("aMsg", "");
  show("stepB", false);
  $("fieldsPreview").innerHTML = "";
  $("stepBMsg").textContent = "";

  try{
    await ensureSession();

    const fd = new FormData();
    fd.append("prompt", ($("prompt").value || "").toString());
    const f = $("file").files[0];
    if(f) fd.append("file", f);

    const r = await fetch(`${ORCH}/profile/${encodeURIComponent(sid)}`, { method:"POST", body: fd });
    const text = await r.text();
    let data = {};
    try { data = JSON.parse(text || "{}"); } catch { /* keep default */ }

    if(!r.ok){
      console.error("PROFILE ERROR", r.status, text);
      throw new Error(data?.error || text || `HTTP ${r.status}`);
    }

    // --- Robust field extraction (new and legacy keys) ---
    const fields = pickFields(data);
    const qCount = Array.isArray(data?.questions) ? data.questions.length : 0;

    if(fields.length){
      setMsg("aMsg", `Profiling complete. Detected ${fields.length} fields` + (qCount ? ` • ${qCount} questions` : ""), "ok");
      $("stepBMsg").textContent = `Detected ${fields.length} fields.` + (qCount ? ` There are ${qCount} questions.` : "");
      renderFieldsPreview(fields);
      show("stepB", true);
    } else {
      setMsg("aMsg", "Profiling completed but no fields were detected. Check your file format.", "err");
      show("stepB", false);
    }
  }catch(e){
    console.error(e);
    setMsg("aMsg", "Profiling failed. Check logs.", "err");
  }finally{
    setBusy(btn, false);
  }
}

/* ======== BOOT ======== */
(async () => {
  try {
    await ensureSession();
  } catch(e) {
    console.error(e);
    setMsg("aMsg", "Could not create a session. Please reload.", "err");
  }
  $("newSession").addEventListener("click", onNewSession, {passive:true});
  $("start").addEventListener("click", onProfile, {passive:true});
})();
</script>
</body>
</html>