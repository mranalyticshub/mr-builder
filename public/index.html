<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>MR Analytics Hub – Dashboard Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --gap:16px; --gridCols:12; --gridRows:9; }
    html, body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; color:#111;}
    .wrap { max-width: 1240px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 16px; font-size: 38px; letter-spacing:.2px}
    h2 { margin: 0 0 10px; }
    .muted { color:#666; font-size:13px; }
    .row { display:flex; align-items:center; gap:12px; }
    .sid-badge { background:#fafafa; border:1px solid #e7e7e7; padding:6px 8px; border-radius:6px; font-size:12px; }
    .card { border:1px solid #eee; padding:16px; border-radius:10px; background:#fff; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button { appearance:none; background:#111; color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#f5f5f5; color:#111; border:1px solid #ddd; }
    button[disabled] { opacity:.55; cursor:not-allowed; }
    input[type="text"], input[type="email"], select, textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #ddd; }
    textarea { min-height: 140px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    .hidden { display:none; }
    .err { color:#b00020; }
    .ok { color:#0a6; }

    /* table */
    .tbl-wrap { max-height: 360px; overflow:auto; border:1px solid #eee; border-radius:10px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #f0f0f0; padding:10px 12px; vertical-align: top; }
    th { position: sticky; top:0; background:#fff; z-index:1; }
    td.editable { background:#fffdf7; outline: 0; }
    td.editable:focus { box-shadow: inset 0 0 0 2px #ffe7a3; background:#fff9e6; }

    /* questions */
    .qgrid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .qcard { border:1px dashed #e6e6e6; border-radius:10px; padding:14px; }
    .qcard h4 { margin:0 0 6px; font-size:14px; color:#444; }

    /* design grid preview */
    .gridWrap { border:1px solid #eee; border-radius:10px; padding:8px; background:#fff; }
    .grid { position: relative; width:100%; height: 560px; background:
      repeating-linear-gradient(to right, #fafafa 0 1px, transparent 1px calc((100%/var(--gridCols)))),
      repeating-linear-gradient(to bottom, #fafafa 0 1px, transparent 1px calc((100%/var(--gridRows))));
      background-size: calc(100%/var(--gridCols)) calc(100%/var(--gridRows));
      border-radius:8px;
    }
    .tile {
      position:absolute; background:#f7f9ff; border:1px solid #dfe7ff; border-radius:8px;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      display:flex; align-items:center; justify-content:center; text-align:center;
      padding:8px;
    }
    .tile .title { font-size:13px; color:#334; }
    .actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:8px">
    <h1 style="flex:1">Dashboard Builder</h1>
    <span class="muted">Session:</span>
    <span id="sidBadge" class="sid-badge">–</span>
    <button id="newSession" class="secondary" type="button" title="Start a fresh session">New session</button>
  </div>

  <!-- STEP A -->
  <div class="card" id="stepA">
    <h2>1) Describe your business or upload a sample</h2>
    <textarea id="prompt" placeholder="What’s your business and what should the dashboard show?"></textarea>
    <div class="toolbar" style="margin-top:8px">
      <input id="file" type="file" accept=".csv,.xlsx"/>
      <button id="start" type="button">Profile dataset</button>
      <span id="aMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP B -->
  <div class="card hidden" id="stepB">
    <h2>2) Field Map</h2>
    <div class="muted" style="margin-bottom:8px">
      Detected <span id="fldCount">0</span> fields. There are <span id="qCount">0</span> questions. Preview of detected fields:
      <div>Tips: click in the <b>dtype</b>, <b>allowed</b> or <b>description</b> cells to edit. Changes are kept locally and used when designing.</div>
    </div>

    <div class="tbl-wrap">
      <table id="fieldTable">
        <thead>
        <tr>
          <th style="width:220px">field</th>
          <th style="width:110px">dtype</th>
          <th style="width:200px">allowed</th>
          <th>description</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2 style="margin-top:18px">3) Questions</h2>
    <div class="muted" style="margin-bottom:8px">Please answer briefly, or leave blank.</div>
    <div id="qGrid" class="qgrid"></div>

    <div class="actions">
      <button id="toDesign" type="button">Continue to design</button>
      <span id="bMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP C -->
  <div class="card hidden" id="stepC">
    <h2>4) Design & Preview</h2>
    <div id="cMsg" class="muted" style="margin-bottom:8px"></div>
    <div class="gridWrap">
      <div id="grid" class="grid" aria-label="Layout preview (tiles from DSL)"></div>
    </div>
  </div>
</div>

<script>
/* ======== CONFIG ======== */
const ORCH = "https://mr-orchestrator-585407302606.europe-west2.run.app";

/* ======== HELPERS ======== */
const $ = (id) => document.getElementById(id);
function setMsg(id, text, cls="muted"){ const el=$(id); if(!el) return; el.className=cls; el.textContent = text||""; }
function show(id, flag){ $(id).classList.toggle("hidden", !flag); }
function setBusy(btn, on, label="Working…"){
  if(!btn) return;
  btn.disabled = !!on;
  if(on){ btn.dataset._t = btn.textContent; btn.textContent = label; }
  else if(btn.dataset._t){ btn.textContent = btn.dataset._t; delete btn.dataset._t; }
}
function readQuery(k){ const p = new URLSearchParams(location.search); return p.get(k); }
function cookieGet(name){ return (`; ${document.cookie}`).split(`; ${name}=`).pop().split(';')[0] || ""; }
function cookieSet(name, value){ document.cookie = `${name}=${value}; Max-Age=3600; Path=/; SameSite=None; Secure`; }
function cookieDel(name){ document.cookie = `${name}=; Max-Age=0; Path=/; SameSite=None; Secure`; }

/* ======== STATE ======== */
let sid = null;
let fields = [];           // working copy of schema rows {field, dtype, allowed, description}
let questions = [];        // [{id,text,answer}]
let dsl = null;

/* ======== SESSION ======== */
async function createSession(){
  let r = await fetch(`${ORCH}/session`, {
    method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({prompt:""})
  });
  if(r.status === 422){ r = await fetch(`${ORCH}/session`, { method:"POST" }); }
  const j = await r.json();
  const newSid = j.sid || j.session_id;
  if(!newSid) throw new Error("No sid in /session response");
  cookieSet("mr_sid", newSid);
  sid = newSid;
  $("sidBadge").textContent = sid;
  return sid;
}

async function ensureSession(){
  if(readQuery("new") === "1"){ cookieDel("mr_sid"); }
  const urlSid = (readQuery("sid") || "").trim();
  const ckSid  = (cookieGet("mr_sid") || "").trim();
  if(urlSid){ sid = urlSid; cookieSet("mr_sid", sid); $("sidBadge").textContent = sid; return sid; }
  if(ckSid){ sid = ckSid; $("sidBadge").textContent = sid; return sid; }
  return await createSession();
}

/* ======== RENDERERS ======== */
function renderFieldsTable(rows){
  const tbody = $("fieldTable").querySelector("tbody");
  tbody.innerHTML = "";
  rows.forEach((r, i) => {
    const tr = document.createElement("tr");
    const tdField = document.createElement("td");
    tdField.textContent = r.field || "";
    tdField.style.fontWeight = "600";
    tr.appendChild(tdField);

    const tdDtype = document.createElement("td");
    tdDtype.className = "editable";
    tdDtype.contentEditable = "true";
    tdDtype.textContent = r.dtype || "";
    tdDtype.dataset.row = i; tdDtype.dataset.key = "dtype";
    tr.appendChild(tdDtype);

    const tdAllowed = document.createElement("td");
    tdAllowed.className = "editable";
    tdAllowed.contentEditable = "true";
    tdAllowed.textContent = r.allowed || "";
    tdAllowed.dataset.row = i; tdAllowed.dataset.key = "allowed";
    tr.appendChild(tdAllowed);

    const tdDesc = document.createElement("td");
    tdDesc.className = "editable";
    tdDesc.contentEditable = "true";
    tdDesc.textContent = r.description || "";
    tdDesc.dataset.row = i; tdDesc.dataset.key = "description";
    tr.appendChild(tdDesc);

    tbody.appendChild(tr);
  });

  // delegate changes (keep state in `fields`)
  tbody.addEventListener("blur", (ev) => {
    const t = ev.target;
    if(!t.classList.contains("editable")) return;
    const row = Number(t.dataset.row);
    const key = t.dataset.key;
    if(!Number.isFinite(row) || !key) return;
    fields[row][key] = t.textContent.trim();
  }, true);
}

function renderQuestions(qs){
  const root = $("qGrid");
  root.innerHTML = "";
  qs.forEach((q, i) => {
    const card = document.createElement("div");
    card.className = "qcard";
    const h = document.createElement("h4");
    h.textContent = `Question ${i+1}`;
    const p = document.createElement("div");
    p.style.marginBottom = "6px";
    p.textContent = q.text || q.question || "";
    const ta = document.createElement("textarea");
    ta.placeholder = "Your answer (optional)";
    ta.value = q.answer || "";
    ta.addEventListener("input", () => { q.answer = ta.value; });
    card.append(h, p, ta);
    root.appendChild(card);
  });
}

function renderDesignGrid(dslObj){
  const grid = $("grid");
  grid.innerHTML = "";
  if(!dslObj || !dslObj.pages || !dslObj.pages[0] || !Array.isArray(dslObj.pages[0].tiles)){
    setMsg("cMsg", "No tiles returned in DSL. Edit the schema/answers and try again.", "err");
    return;
  }
  const tiles = dslObj.pages[0].tiles;

  // position tiles in a 12x9 grid
  grid.style.setProperty("--gridCols", 12);
  grid.style.setProperty("--gridRows", 9);

  const toPct = (val, total) => `${(val/total)*100}%`;

  tiles.forEach((t) => {
    // sanitize & defaults
    const x = Math.max(0, Number(t.x||0));
    const y = Math.max(0, Number(t.y||0));
    const w = Math.max(1, Number(t.w||3));
    const h = Math.max(1, Number(t.h||3));
    const div = document.createElement("div");
    div.className = "tile";
    div.style.left   = toPct(x, 12);
    div.style.top    = toPct(y, 9);
    div.style.width  = toPct(w, 12);
    div.style.height = toPct(h, 9);
    const label = document.createElement("div");
    label.className = "title";
    label.textContent = t.title || `${t.type||"tile"}`;
    div.appendChild(label);
    grid.appendChild(div);
  });
}

/* ======== WIRES ======== */
async function onNewSession(){
  try{
    setBusy($("newSession"), true, "Starting…");
    cookieDel("mr_sid");
    await createSession();
    setMsg("aMsg", "New session started.", "ok");
  }catch(e){
    console.error(e);
    setMsg("aMsg", "Could not start a new session.", "err");
  }finally{
    setBusy($("newSession"), false);
  }
}

async function onProfile(){
  const btn = $("start");
  setBusy(btn, true, "Profiling…");
  setMsg("aMsg", "");
  try{
    await ensureSession();

    const fd = new FormData();
    fd.append("prompt", ($("prompt").value || "").toString());
    const f = $("file").files[0];
    if(f) fd.append("file", f);

    const r = await fetch(`${ORCH}/profile/${encodeURIComponent(sid)}`, { method:"POST", body: fd });
    const text = await r.text();
    let data = {};
    try { data = JSON.parse(text || "{}"); } catch { /* keep default */ }

    if(!r.ok){
      console.error("PROFILE ERROR", r.status, text);
      throw new Error(data?.error || text || `HTTP ${r.status}`);
    }

    // Accept either `field_map.tables[0].fields` or legacy `{schema_table|fields}`
    const detected =
      data?.field_map?.tables?.[0]?.fields ||
      data?.schema_table ||
      data?.fields || [];

    // Normalize to editable rows
    fields = detected.map(x => ({
      field: x.field || x.name || "",
      dtype: (x.dtype || x.type || "").toString(),
      allowed: (x.allowed || x.constraint || "").toString(),
      description: (x.description || "").toString()
    }));

    questions = (data.questions || []).map((q, i) => ({
      id: q.id || `q${i+1}`,
      text: q.text || q.question || "",
      answer: q.answer || ""
    }));

    $("fldCount").textContent = fields.length;
    $("qCount").textContent = questions.length;

    renderFieldsTable(fields);
    renderQuestions(questions);

    setMsg("aMsg", `Profiling complete. Detected ${fields.length} fields • ${questions.length} questions`, "ok");
    show("stepB", true);
    show("stepC", false);
  }catch(e){
    console.error(e);
    setMsg("aMsg", "Profiling failed. Check logs.", "err");
  }finally{
    setBusy(btn, false);
  }
}

async function onDesign(){
  const btn = $("toDesign");
  setBusy(btn, true, "Designing…");
  setMsg("bMsg", "");
  try{
    // payload is the edited fields + answers only
    const body = {
      schema_table: fields.map(r => ({
        field:r.field, dtype:r.dtype, allowed:r.allowed, description:r.description
      })),
      answers: questions.map(q => q.answer || "").filter(Boolean)
    };

    const r = await fetch(`${ORCH}/design/${encodeURIComponent(sid)}`, {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
    });
    const text = await r.text();
    let data = {};
    try { data = JSON.parse(text || "{}"); } catch {}
    if(!r.ok){
      console.error("DESIGN ERROR", r.status, text);
      throw new Error(data?.error || text || `HTTP ${r.status}`);
    }

    dsl = data.dsl || data;
    setMsg("bMsg", "Design created.", "ok");
    show("stepC", true);
    setMsg("cMsg", "Page 1 preview (layout only).", "muted");
    renderDesignGrid(dsl);
  }catch(e){
    console.error(e);
    setMsg("bMsg", "Design failed. Check logs.", "err");
  }finally{
    setBusy(btn, false);
  }
}

/* ======== BOOT ======== */
(async () => {
  try { await ensureSession(); }
  catch(e) {
    console.error(e);
    setMsg("aMsg", "Could not create a session. Please reload.", "err");
  }
  $("newSession").addEventListener("click", onNewSession, {passive:true});
  $("start").addEventListener("click", onProfile, {passive:true});
  $("toDesign").addEventListener("click", onDesign, {passive:true});
})();
</script>
</body>
</html>