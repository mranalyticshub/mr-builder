<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>MR Analytics Hub – Dashboard Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --gap:16px; }
    html, body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; color:#111;}
    .wrap { max-width: 1240px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 16px; font-size: 38px; letter-spacing:.2px}
    h2 { margin: 0 0 10px; }
    h3 { margin: 0 0 8px; }
    .muted { color:#666; font-size:13px; }
    .row { display:flex; align-items:center; gap:12px; }
    .sid-badge { background:#fafafa; border:1px solid #e7e7e7; padding:6px 8px; border-radius:6px; font-size:12px; }
    .card { border:1px solid #eee; padding:16px; border-radius:10px; background:#fff; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button { appearance:none; background:#111; color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; }
    button.ghost { background:#f5f5f5; color:#111; border:1px solid #ddd; }
    button[disabled] { opacity:.55; cursor:not-allowed; }
    input[type="text"], input[type="email"], select, textarea { width:100%; padding:9px 10px; border-radius:8px; border:1px solid #ddd; }
    textarea { min-height: 140px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; z-index:1;}
    .scroll { max-height: 360px; overflow:auto; border:1px solid #eee; border-radius:8px; }
    iframe { border:1px solid #eee; width:100%; height: 760px; border-radius:10px; }
    .step { margin-bottom: 20px; }
    .hidden { display:none; }
    .err { color:#b00020; }
    .ok { color:#0a6; }
    .pill { font-size:12px; background:#f2f2f2; padding:2px 8px; border-radius:999px; border:1px solid #e9e9e9; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:8px">
    <h1 style="flex:1">Dashboard Builder</h1>
    <span class="muted">Session:</span><span id="sidBadge" class="sid-badge">–</span>
  </div>

  <!-- STEP A: Profile & Upload -->
  <div class="card step" id="stepA">
    <h2>1) Describe your business or upload a sample</h2>
    <textarea id="prompt" placeholder="What’s your business and what should the dashboard show?"></textarea>
    <div class="toolbar" style="margin-top:8px">
      <input id="file" type="file" accept=".csv,.xlsx"/>
      <button id="start" type="button" onclick="window._start && window._start()">Profile dataset</button>
      <span id="aMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP B: Review fields & questions -->
  <div class="card step hidden" id="stepB">
    <div class="grid-2">
      <div>
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <h2 style="margin:0">2) Field Map</h2>
          <span class="pill" id="fieldCount">0 fields</span>
        </div>
        <div class="scroll">
          <table id="fieldTable">
            <thead>
              <tr>
                <th>Field</th><th>Type</th><th>Semantic</th><th>Unit/Grain</th><th>Description</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <small class="muted">Edit semantics/description if needed.</small>
      </div>
      <div>
        <h2>Questions</h2>
        <div id="qBox" class="scroll" style="padding:8px"></div>
        <small class="muted">Please answer any required questions before continuing.</small>
      </div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button id="toDesign">Continue to design</button>
      <button id="downloadSpec" class="ghost">Download spec (JSON)</button>
      <span id="bMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP C: Design & Preview (full width) -->
  <div class="card step hidden" id="stepC">
    <h2>3) Design & Preview</h2>
    <div class="toolbar" style="margin-bottom:8px">
      <input id="nl" placeholder="e.g., add a bar of returns by category; compare last month"/>
      <button id="applyNl">Apply change</button>
      <span id="cMsg" class="muted"></span>
    </div>
    <iframe id="preview" src=""></iframe>

    <div class="grid-2" style="margin-top:16px">
      <div class="card">
        <h3>Approve & Continue</h3>
        <input id="company" placeholder="Company name"/>
        <input id="email" type="email" placeholder="Contact email"/>
        <button id="approve">Approve design</button>
        <div id="plan" class="muted" style="margin-top:8px"></div>
      </div>
      <div class="card">
        <h3>Session tools</h3>
        <div class="toolbar">
          <button id="reloadPreview" class="ghost">Reload preview</button>
          <span class="muted">Preview SID is carried as a query param.</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ========================== -->
<!-- Main Script -->
<!-- ========================== -->
<script>
const ORCH = "https://mr-orchestrator-585407302606.europe-west2.run.app";
let sid = null, fieldMap = null, questions = [];

function setMsg(id, text){ const el=document.getElementById(id); if(el) el.textContent=text||""; }
function show(id,flag){ const el=document.getElementById(id); if(el) el.classList.toggle("hidden",!flag); }
function setBusy(btn,on,msg="Working…"){ if(!btn)return; btn.disabled=!!on; if(on){btn.dataset.t=btn.textContent;btn.textContent=msg;} else if(btn.dataset.t){btn.textContent=btn.dataset.t;} }

async function ensureSession(){
  if(sid) return sid;
  const r=await fetch(`${ORCH}/session`,{method:"POST"});
  if(!r.ok) throw new Error("/session failed");
  const j=await r.json(); sid=j.session_id||j.sid||j.id; if(!sid) throw new Error("no sid");
  document.getElementById("sidBadge").textContent=sid; return sid;
}

function renderFieldTable(map){
  const tb=document.querySelector("#fieldTable tbody"); tb.innerHTML="";
  const fields=(map?.tables?.[0]?.fields)||[];
  document.getElementById("fieldCount").textContent=`${fields.length} field${fields.length===1?"":"s"}`;
  for(const f of fields){
    const tr=document.createElement("tr");
    tr.dataset.field=f.name;
    tr.innerHTML=`
      <td><strong>${f.name}</strong></td>
      <td><select data-k="type">
        <option ${f.type==="STRING"?"selected":""}>STRING</option>
        <option ${f.type==="NUMERIC"?"selected":""}>NUMERIC</option>
        <option ${f.type==="DATE"?"selected":""}>DATE</option>
      </select></td>
      <td><select data-k="semantic">
        <option value="">—</option>
        <option value="id" ${f.semantic==="id"?"selected":""}>id</option>
        <option value="date" ${f.semantic==="date"?"selected":""}>date</option>
        <option value="currency" ${f.semantic==="currency"?"selected":""}>currency</option>
        <option value="category" ${f.semantic==="category"?"selected":""}>category</option>
      </select></td>
      <td><input data-k="unit" placeholder="GBP, %, day, month" value="${f.unit||f.grain||""}"/></td>
      <td><input data-k="desc" placeholder="Short explanation" value="${f.desc||""}"/></td>`;
    tb.appendChild(tr);
  }
}
function renderQuestions(qs){
  const box=document.getElementById("qBox"); box.innerHTML="";
  for(const q of qs){
    const wrap=document.createElement("div");
    wrap.style.marginBottom="12px";
    wrap.innerHTML=`<div><strong>${q.prompt||""}</strong></div>`;
    let input=document.createElement(q.kind==="select"?"select":"input");
    if(q.kind==="select"){ (q.options||[]).forEach(o=>{const opt=document.createElement("option");opt.value=o;opt.textContent=o;input.appendChild(opt)}); }
    else input.placeholder=q.placeholder||"";
    if(q.default) input.value=q.default;
    input.dataset.qid=q.id; input.style.width="100%"; wrap.appendChild(input); box.appendChild(wrap);
  }
}
function collectFieldMapEdits(){
  const rows=document.querySelectorAll("#fieldTable tbody tr");
  const by={}; rows.forEach(r=>{const n=r.dataset.field;const o={};r.querySelectorAll("[data-k]").forEach(el=>o[el.dataset.k]=el.value.trim());by[n]=o;});
  const table=fieldMap.tables[0];
  table.fields=table.fields.map(f=>{const e=by[f.name]||{};return{...f,type:e.type||f.type,semantic:e.semantic||f.semantic||"",unit:e.unit||f.unit,grain:e.unit||f.grain,desc:e.desc||f.desc||""};});
  return fieldMap;
}
function collectAnswers(){
  const inputs=document.querySelectorAll("#qBox [data-qid]"); const ans={}; inputs.forEach(i=>ans[i.dataset.qid]=i.value.trim()); return ans;
}

/* --- Handlers --- */
window._start=async function(){
  const btn=document.getElementById("start");
  setBusy(btn,true,"Profiling…"); setMsg("aMsg","");
  try{
    await ensureSession();
    const fd=new FormData();
    fd.append("prompt",document.getElementById("prompt").value||"");
    const f=document.getElementById("file").files[0]; if(f) fd.append("file",f);
    const r=await fetch(`${ORCH}/profile/${sid}`,{method:"POST",body:fd});
    const txt=await r.text(); if(!r.ok) throw new Error(txt);
    const data=JSON.parse(txt||"{}");
    fieldMap=data.field_map||{}; questions=data.questions||[];
    renderFieldTable(fieldMap); renderQuestions(questions);
    show("stepB",true); setMsg("aMsg","Profiling complete. Review fields and answer questions.");
    document.getElementById("stepB").scrollIntoView({behavior:"smooth"});
  }catch(e){ console.error(e); setMsg("aMsg","Profiling failed. Check logs."); }
  finally{ setBusy(btn,false); }
};

async function onDesign(){
  const btn=document.getElementById("toDesign"); setBusy(btn,true,"Building…"); setMsg("bMsg","");
  try{
    const fm=collectFieldMapEdits(), ans=collectAnswers();
    await fetch(`${ORCH}/field-map/${sid}`,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(fm)});
    const r=await fetch(`${ORCH}/design/${sid}`,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({answers:ans})});
    const data=await r.json(); document.getElementById("preview").src=data.preview_url+"&_="+Date.now();
    show("stepC",true); document.getElementById("stepC").scrollIntoView({behavior:"smooth"});
  }catch(e){console.error(e); setMsg("bMsg","Design failed. Check logs.");}
  finally{setBusy(btn,false);}
}
async function onNlEdit(){
  const btn=document.getElementById("applyNl"); setBusy(btn,true,"Applying…");
  try{
    const r=await fetch(`${ORCH}/nl-edit/${sid}`,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({instruction:document.getElementById("nl").value})});
    const data=await r.json(); document.getElementById("preview").src=data.preview_url+"&_="+Date.now();
  }catch(e){console.error(e);} finally{setBusy(btn,false);}
}
async function onApprove(){
  const c=document.getElementById("company").value.trim(), e=document.getElementById("email").value.trim();
  if(!c||!e) return alert("Company and email required");
  const r=await fetch(`${ORCH}/approve/${sid}`,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({company:c,email:e})});
  const d=await r.json(); document.getElementById("plan").innerHTML=`<strong>${d.plan}</strong> – ${d.reason}<br><a href="${d.signup_url}" target="_blank">Continue to Sign Up</a>`;
}
async function onDownloadSpec(){
  const r=await fetch(`${ORCH}/artifacts?sid=${encodeURIComponent(sid)}`); const d=await r.json();
  const blob=new Blob([JSON.stringify(d,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`mr_draft_${sid}.json`; a.click();
}
document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("toDesign").addEventListener("click",onDesign);
  document.getElementById("applyNl").addEventListener("click",onNlEdit);
  document.getElementById("approve").addEventListener("click",onApprove);
  document.getElementById("downloadSpec").addEventListener("click",onDownloadSpec);
  document.getElementById("reloadPreview").addEventListener("click",()=>{const p=document.getElementById("preview");p.src=p.src.split("&_=")[0]+"&_="+Date.now();});
  console.log("[UI] Bound handlers");
});
</script>
</body>
</html>