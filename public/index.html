<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>MR Analytics Hub – Dashboard Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --gap:16px; }
    html, body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; color:#111;}
    .wrap { max-width: 1240px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 16px; font-size: 38px; letter-spacing:.2px}
    h2 { margin: 0 0 10px; }
    .muted { color:#666; font-size:13px; }
    .row { display:flex; align-items:center; gap:12px; }
    .sid-badge { background:#fafafa; border:1px solid #e7e7e7; padding:6px 8px; border-radius:6px; font-size:12px; }
    .card { border:1px solid #eee; padding:16px; border-radius:10px; background:#fff; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button { appearance:none; background:#111; color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#f5f5f5; color:#111; border:1px solid #ddd; }
    button[disabled] { opacity:.55; cursor:not-allowed; }
    input[type="text"], input[type="email"], select, textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #ddd; }
    textarea { min-height: 140px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    .hidden { display:none; }
    .err { color:#b00020; }
    .ok { color:#0a6; }

    /* Field table */
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 12px; border-bottom:1px solid #eee; vertical-align: top; }
    td[contenteditable="true"] { background:#fcfcfc; outline:none; }
    .scroll { max-height: 340px; overflow: auto; border:1px solid #f1f1f1; border-radius:8px; }

    /* Preview grid (12-col) */
    .preview-grid { position:relative; width:100%; border:1px dashed #ddd; border-radius:10px; padding:12px; }
    .grid-inner { position:relative; width:100%; height:680px; background:repeating-linear-gradient(to right, #fafafa 0 1px, transparent 1px 8.333%); }
    .tile { position:absolute; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,.08); border:1px solid #eee; border-radius:10px; overflow:hidden; display:flex; flex-direction:column;}
    .tile h4 { margin:0; padding:10px 12px; font-size:14px; border-bottom:1px solid #f5f5f5; background:#fcfcfc;}
    .tile .body { padding:12px; font-size:12px; color:#666; }
    .tiny { font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:8px">
    <h1 style="flex:1">Dashboard Builder</h1>
    <span class="muted">Session:</span>
    <span id="sidBadge" class="sid-badge">–</span>
    <button id="newSession" class="secondary" type="button" title="Start a fresh session">New session</button>
  </div>

  <!-- STEP A -->
  <div class="card" id="stepA">
    <h2>1) Describe your business or upload a sample</h2>
    <textarea id="prompt" placeholder="What’s your business and what should the dashboard show?"></textarea>
    <div class="toolbar" style="margin-top:8px">
      <input id="file" type="file" accept=".csv,.xlsx"/>
      <button id="start" type="button">Profile dataset</button>
      <span id="aMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP B -->
  <div class="card hidden" id="stepB">
    <h2>2) Field Map</h2>
    <div id="stepBMsg" class="muted"></div>

    <div class="scroll" style="margin-top:12px">
      <table id="fieldsTable">
        <thead>
          <tr><th style="width:220px">field</th><th style="width:130px">dtype</th><th style="width:180px">allowed</th><th>description</th></tr>
        </thead>
        <tbody id="fieldsBody"></tbody>
      </table>
    </div>

    <div style="margin-top:16px">
      <h3>3) Questions</h3>
      <div id="questionsWrap" class="muted tiny">No questions yet.</div>
    </div>

    <div class="toolbar" style="margin-top:14px">
      <button id="toDesign" type="button">Continue to design</button>
      <span id="bMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP C -->
  <div class="card hidden" id="stepC">
    <h2>3) Design & Preview</h2>
    <div id="cMsg" class="muted"></div>
    <div class="preview-grid" style="margin-top:10px">
      <div id="grid" class="grid-inner"></div>
    </div>
  </div>
</div>

<script>
/* ======== CONFIG ======== */
const ORCH = "https://mr-orchestrator-585407302606.europe-west2.run.app";

/* ======== HELPERS ======== */
const $ = (id) => document.getElementById(id);
function setMsg(id, text, cls="muted"){ const el=$(id); if(!el) return; el.className=cls; el.textContent = text||""; }
function show(id, flag){ $(id).classList.toggle("hidden", !flag); }
function setBusy(btn, on, label="Working…"){
  if(!btn) return;
  btn.disabled = !!on;
  if(on){ btn.dataset._t = btn.textContent; btn.textContent = label; }
  else if(btn.dataset._t){ btn.textContent = btn.dataset._t; delete btn.dataset._t; }
}
function readQuery(k){ const p = new URLSearchParams(location.search); return p.get(k); }
function cookieGet(name){ return (`; ${document.cookie}`).split(`; ${name}=`).pop().split(';')[0] || ""; }
function cookieSet(name, value){ document.cookie = `${name}=${value}; Max-Age=3600; Path=/; SameSite=None; Secure`; }
function cookieDel(name){ document.cookie = `${name}=; Max-Age=0; Path=/; SameSite=None; Secure`; }

/* ======== STATE ======== */
let sid = null;
let schemaFields = [];        // editable fields
let questions = [];           // clarifying qs
let dsl = null;               // returned dashboard

/* ======== SESSION ======== */
async function createSession(){
  let r = await fetch(`${ORCH}/session`, {
    method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({prompt:""})
  });
  if(r.status === 422){ r = await fetch(`${ORCH}/session`, { method:"POST" }); }
  const j = await r.json();
  const newSid = j.sid || j.session_id;
  if(!newSid) throw new Error("No sid in /session response");
  cookieSet("mr_sid", newSid);
  sid = newSid;
  $("sidBadge").textContent = sid;
  return sid;
}

async function ensureSession(){
  if(readQuery("new") === "1"){ cookieDel("mr_sid"); }
  const urlSid = (readQuery("sid") || "").trim();
  const ckSid  = (cookieGet("mr_sid") || "").trim();
  if(urlSid){ sid = urlSid; cookieSet("mr_sid", sid); $("sidBadge").textContent = sid; return sid; }
  if(ckSid){ sid = ckSid; $("sidBadge").textContent = sid; return sid; }
  return await createSession();
}

/* ======== UI – fields & questions ======== */
function renderFields(fields){
  const tb = $("fieldsBody");
  tb.innerHTML = "";
  fields.forEach((f,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f.field ?? ""}</td>
      <td contenteditable="true" data-k="dtype">${f.dtype ?? ""}</td>
      <td contenteditable="true" data-k="allowed">${f.allowed ?? ""}</td>
      <td contenteditable="true" data-k="description">${f.description ?? ""}</td>`;
    tr.querySelectorAll('[contenteditable="true"]').forEach(cell=>{
      cell.addEventListener("blur", ()=>{
        const k = cell.dataset.k;
        schemaFields[i][k] = cell.textContent.trim();
      });
    });
    tb.appendChild(tr);
  });
}

function renderQuestions(qs){
  const wrap = $("questionsWrap");
  if(!qs?.length){ wrap.textContent = "No questions."; return; }
  wrap.innerHTML = "";
  qs.forEach((q, idx)=>{
    const card = document.createElement("div");
    card.style = "margin:10px 0; border:1px solid #eee; border-radius:8px; padding:10px 12px; background:#fff;";
    card.innerHTML = `<div class="tiny muted" style="margin-bottom:6px">Question ${idx+1}</div>
                      <div style="margin-bottom:8px">${q}</div>
                      <textarea data-idx="${idx}" placeholder="Your answer (optional)"></textarea>`;
    wrap.appendChild(card);
  });
}

/* ======== STEP A – Profile ======== */
async function onNewSession(){
  try{
    setBusy($("newSession"), true, "Starting…");
    cookieDel("mr_sid");
    await createSession();
    setMsg("aMsg", "New session started.", "ok");
    show("stepB", false); show("stepC", false);
  }catch(e){
    console.error(e);
    setMsg("aMsg", "Could not start a new session.", "err");
  }finally{
    setBusy($("newSession"), false);
  }
}

async function onProfile(){
  const btn = $("start");
  setBusy(btn, true, "Profiling…");
  setMsg("aMsg", "");
  try{
    await ensureSession();

    const fd = new FormData();
    fd.append("prompt", ($("prompt").value || "").toString());
    const f = $("file").files[0];
    if(f) fd.append("file", f);

    const r = await fetch(`${ORCH}/profile/${encodeURIComponent(sid)}`, { method:"POST", body: fd });
    const text = await r.text();
    let data = {};
    try { data = JSON.parse(text || "{}"); } catch {}
    if(!r.ok){ throw new Error(data?.error || text || `HTTP ${r.status}`); }

    // hydrate table & questions
    schemaFields = data.schema_table || data.fields || [];
    questions    = data.questions || [];

    const previewCt = Math.min(6, schemaFields.length);
    setMsg("aMsg", `Profiling complete. Detected ${schemaFields.length} fields • ${questions.length} questions`, "ok");
    $("stepBMsg").textContent = `Detected ${schemaFields.length} fields. There are ${questions.length} questions.\nPreview of detected fields:`;
    renderFields(schemaFields.slice(0, previewCt));   // show first 6 rows; you already saw it scrollable
    renderQuestions(questions);

    show("stepB", true);
    show("stepC", false);
  }catch(e){
    console.error(e);
    setMsg("aMsg", "Profiling failed. Check logs.", "err");
  }finally{
    setBusy(btn, false);
  }
}

/* ======== STEP C – Design & Preview ======== */
function colWidthPx(){ return $("grid").clientWidth / 12; }
function gridToPx(n){ return Math.round(n * colWidthPx()); }
function rowToPx(n){ return Math.round(n * 56); }  // ~56px row height (tweak if you like)

function renderPreview(d){
  const grid = $("grid");
  grid.innerHTML = "";
  if(!d?.pages?.length){ setMsg("cMsg","Design has no pages.","err"); return; }
  const page = d.pages[0];
  const tiles = page.tiles || [];
  tiles.forEach(t=>{
    // defaults
    const x = Math.max(0, t.x ?? 0), y = Math.max(0, t.y ?? 0),
          w = Math.min(12, t.w ?? 4), h = Math.max(1, t.h ?? 3);

    const div = document.createElement("div");
    div.className = "tile";
    div.style.left   = gridToPx(x) + "px";
    div.style.top    = rowToPx(y)  + "px";
    div.style.width  = gridToPx(w) + "px";
    div.style.height = rowToPx(h)  + "px";
    div.innerHTML = `<h4>${t.title || t.type || "tile"}</h4>
                     <div class="body tiny">type: ${t.type || "?"}<br/>w×h: ${w}×${h} @ (${x},${y})</div>`;
    grid.appendChild(div);
  });
}

async function onDesign(){
  const btn = $("toDesign");
  setBusy(btn, true, "Designing…");
  setMsg("bMsg", "");
  try{
    // collect answers (optional)
    const answers = Array.from($("questionsWrap").querySelectorAll("textarea")).map(t=>t.value.trim()).filter(Boolean);

    const body = {
      schema_table: schemaFields,  // your edits are in-memory already
      answers
    };
    const r = await fetch(`${ORCH}/design/${encodeURIComponent(sid)}`, {
      method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!r.ok){ throw new Error(j?.error || `HTTP ${r.status}`); }

    dsl = j.dsl || j;
    setMsg("bMsg","Design created.","ok");
    setMsg("cMsg","Page 1 preview (layout only).","muted");
    renderPreview(dsl);
    show("stepC", true);
    // scroll to preview
    document.getElementById("stepC").scrollIntoView({behavior:"smooth"});
  }catch(e){
    console.error(e);
    setMsg("bMsg","Design failed. Check logs.","err");
  }finally{
    setBusy(btn,false);
  }
}

/* ======== BOOT ======== */
(async () => {
  try { await ensureSession(); } catch(e){ console.error(e); setMsg("aMsg","Could not create a session. Please reload.","err"); }
  $("newSession").addEventListener("click", onNewSession, {passive:true});
  $("start").addEventListener("click", onProfile, {passive:true});
  $("toDesign").addEventListener("click", onDesign, {passive:true});
})();
</script>
</body>
</html>