<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>MR Analytics Hub – Dashboard Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --gap:16px; }
    html, body { margin:0; padding:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; color:#111;}
    .wrap { max-width: 1240px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 16px; font-size: 38px; letter-spacing:.2px}
    h2 { margin: 0 0 10px; }
    h3 { margin: 0 0 8px; }
    .muted { color:#666; font-size:13px; }
    .row { display:flex; align-items:center; gap:12px; }
    .sid-badge { background:#fafafa; border:1px solid #e7e7e7; padding:6px 8px; border-radius:6px; font-size:12px; }
    .card { border:1px solid #eee; padding:16px; border-radius:10px; background:#fff; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; position:relative; z-index:2; }
    button { appearance:none; background:#111; color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; pointer-events:auto; }
    button.ghost { background:#f5f5f5; color:#111; border:1px solid #ddd; }
    button[disabled] { opacity:.55; cursor:not-allowed; }
    input[type="text"], input[type="email"], select, textarea { width:100%; padding:9px 10px; border-radius:8px; border:1px solid #ddd; }
    textarea { min-height: 140px; font-family: ui-monospace, Menlo, Consolas, monospace; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; z-index:1;}
    .scroll { max-height: 360px; overflow:auto; border:1px solid #eee; border-radius:8px; }
    iframe { border:1px solid #eee; width:100%; height: 760px; border-radius:10px; }
    .step { margin-bottom: 20px; }
    .hidden { display:none; }
    .err { color:#b00020; }
    .ok { color:#0a6; }
    .pill { font-size:12px; background:#f2f2f2; padding:2px 8px; border-radius:999px; border:1px solid #e9e9e9; }
    /* Safety: if a theme injects overlays, keep our controls clickable */
    .wrap, .card, .toolbar, button, input, textarea { pointer-events:auto; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="margin-bottom:8px">
    <h1 style="flex:1">Dashboard Builder</h1>
    <span class="muted">Session:</span><span id="sidBadge" class="sid-badge">–</span>
  </div>

  <!-- STEP A -->
  <div class="card step" id="stepA">
    <h2>1) Describe your business or upload a sample</h2>
    <textarea id="prompt" placeholder="What’s your business and what should the dashboard show?"></textarea>
    <div class="toolbar" style="margin-top:8px">
      <input id="file" type="file" accept=".csv,.xlsx"/>
      <!-- add inline onclick fallback -->
      <button id="start" type="button" onclick="window._onStartClick && window._onStartClick()">Profile dataset</button>
      <span id="aMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP B -->
  <div class="card step hidden" id="stepB">
    <div class="grid-2">
      <div>
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <h2 style="margin:0">2) Field Map</h2>
          <span class="pill" id="fieldCount">0 fields</span>
        </div>
        <div class="scroll">
          <table id="fieldTable">
            <thead>
              <tr>
                <th>Field</th><th>Type</th><th>Semantic</th><th>Unit/Grain</th><th>Description</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <small class="muted">Edit semantics/description if needed.</small>
      </div>
      <div>
        <h2>Questions</h2>
        <div id="qBox" class="scroll" style="padding:8px"></div>
        <small class="muted">Please answer any required questions before continuing.</small>
      </div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button id="toDesign" type="button">Continue to design</button>
      <button id="downloadSpec" class="ghost" type="button">Download spec (JSON)</button>
      <span id="bMsg" class="muted"></span>
    </div>
  </div>

  <!-- STEP C -->
  <div class="card step hidden" id="stepC">
    <h2>3) Design & Preview</h2>
    <div class="toolbar" style="margin-bottom:8px">
      <input id="nl" placeholder="e.g., add a bar of returns by category; compare last month"/>
      <button id="applyNl" type="button">Apply change</button>
      <span id="cMsg" class="muted"></span>
    </div>
    <iframe id="preview" src=""></iframe>

    <div class="grid-2" style="margin-top:16px">
      <div class="card">
        <h3>Approve & Continue</h3>
        <input id="company" placeholder="Company name"/>
        <input id="email" type="email" placeholder="Contact email"/>
        <button id="approve" type="button">Approve design</button>
        <div id="plan" class="muted" style="margin-top:8px"></div>
      </div>
      <div class="card">
        <h3>Session tools</h3>
        <div class="toolbar">
          <button id="reloadPreview" class="ghost" type="button">Reload preview</button>
          <span class="muted">Preview SID is carried as a query param.</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ======== CONFIG ======== */
const ORCH = "https://mr-orchestrator-585407302606.europe-west2.run.app";

/* ======== STATE ======== */
let sid = null;
let fieldMap = null;
let questions = [];

/* ======== UTILS ======== */
const $ = (id) => document.getElementById(id);
function setMsg(id, text, cls="muted"){ const el=$(id); if(!el) return; el.className=cls; el.textContent = text||""; }
function show(id, flag){ $(id).classList.toggle("hidden", !flag); }
function setBusy(btn, on, label="Working…"){
  if(!btn) return;
  btn.disabled = !!on;
  if(on){ btn.dataset._t = btn.textContent; btn.textContent = label; }
  else if(btn.dataset._t){ btn.textContent = btn.dataset._t; delete btn.dataset._t; }
}
function readQuery(k){ const p = new URLSearchParams(location.search); return p.get(k); }
function cookieGet(name){ return (`; ${document.cookie}`).split(`; ${name}=`).pop().split(';')[0] || ""; }
function cookieSet(name, value){ document.cookie = `${name}=${value}; Max-Age=3600; Path=/; SameSite=None; Secure`; }

/* ======== SESSION ======== */
async function ensureSession(){
  if(sid) return sid;
  const urlSid = (readQuery("sid") || "").trim();
  const ckSid  = (cookieGet("mr_sid") || "").trim();
  if(urlSid){ sid=urlSid; cookieSet("mr_sid", sid); $('sidBadge').textContent = sid; return sid; }
  if(ckSid){ sid=ckSid; $('sidBadge').textContent = sid; return sid; }

  try{
    let r = await fetch(`${ORCH}/session`, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({prompt:""}), mode:"cors", cache:"no-store", credentials:"omit",
    });
    if(r.status===422){
      r = await fetch(`${ORCH}/session`, { method:"POST", mode:"cors", cache:"no-store", credentials:"omit" });
    }
    const text = await r.text(); let j={}; try{ j=JSON.parse(text); }catch{}
    sid = j.sid || j.session_id;
    if(!sid) throw new Error(`No sid in /session response (status ${r.status}). Body: ${text.slice(0,400)}`);
    cookieSet("mr_sid", sid); $('sidBadge').textContent = sid;
    console.log("[UI] session ok", sid);
    return sid;
  }catch(err){
    console.error("ensureSession failed:", err);
    setMsg("aMsg", `Could not create a session: ${String(err)}`, "err");
    throw err;
  }
}

/* ======== RENDERERS ======== */
function renderFieldTable(map){
  const tb = $("#fieldTable").querySelector("tbody");
  tb.innerHTML = "";
  const fields = (map?.tables?.[0]?.fields) || [];
  $("#fieldCount").textContent = `${fields.length} field${fields.length===1?"":"s"}`;
  for(const f of fields){
    const tr = document.createElement("tr");
    tr.dataset.field = f.name;
    tr.innerHTML = `
      <td><strong>${f.name}</strong></td>
      <td>
        <select data-k="type">
          <option ${f.type==="STRING"?"selected":""}>STRING</option>
          <option ${f.type==="NUMERIC"?"selected":""}>NUMERIC</option>
          <option ${f.type==="DATE"?"selected":""}>DATE</option>
        </select>
      </td>
      <td>
        <select data-k="semantic">
          <option value="" ${!f.semantic?"selected":""}>—</option>
          <option value="id" ${f.semantic==="id"?"selected":""}>id</option>
          <option value="date" ${f.semantic==="date"?"selected":""}>date</option>
          <option value="currency" ${f.semantic==="currency"?"selected":""}>currency</option>
          <option value="category" ${f.semantic==="category"?"selected":""}>category</option>
        </select>
      </td>
      <td><input type="text" data-k="unit" placeholder="GBP, %, day, month" value="${(f.unit||f.grain||"").toString()}"/></td>
      <td><input type="text" data-k="desc" placeholder="Short explanation" value="${(f.desc||"").toString()}"/></td>`;
    tb.appendChild(tr);
  }
}
function renderQuestions(qs){
  const box = $("#qBox"); box.innerHTML = "";
  for(const q of (qs||[])){
    const wrap = document.createElement("div"); wrap.style.marginBottom="12px";
    wrap.innerHTML = `<div style="margin-bottom:6px"><strong>${q.prompt||""}</strong></div>`;
    let inputEl;
    if(q.kind === "select"){
      inputEl = document.createElement("select");
      (q.options||[]).forEach(o=>{
        const opt = document.createElement("option");
        opt.value=o; opt.textContent=o; inputEl.appendChild(opt);
      });
      if(q.default) inputEl.value = q.default;
    }else{
      inputEl = document.createElement("input");
      inputEl.placeholder = q.placeholder || "";
      if(q.default) inputEl.value = q.default;
    }
    inputEl.dataset.qid = q.id;
    inputEl.style.width = "100%";
    wrap.appendChild(inputEl);
    box.appendChild(wrap);
  }
}

/* ======== COLLECTORS ======== */
function collectFieldMapEdits(){
  const rows = $("#fieldTable").querySelectorAll("tbody tr");
  const idx = {};
  rows.forEach(r=>{
    const name = r.dataset.field;
    const out = {};
    r.querySelectorAll("[data-k]").forEach(el=> out[el.dataset.k] = (el.value||"").trim());
    idx[name] = out;
  });
  const table = fieldMap.tables[0];
  table.fields = table.fields.map(f=>{
    const e = idx[f.name] || {};
    return { ...f,
      type: e.type || f.type,
      semantic: e.semantic || f.semantic || "",
      unit: e.unit || f.unit,
      grain: e.unit || f.grain,
      desc: e.desc || f.desc || ""
    };
  });
  return fieldMap;
}
function collectAnswers(){
  const inputs = $("#qBox").querySelectorAll("[data-qid]");
  const ans = {}; inputs.forEach(i => ans[i.dataset.qid] = (i.value||"").trim());
  return ans;
}

/* ======== ACTIONS ======== */
async function onProfileClick(){
  const btn = $("#start");
  // guard: if a previous in-flight left it disabled, re-enable
  btn.removeAttribute("disabled");
  setBusy(btn, true, "Profiling…");
  setMsg("aMsg", "");
  try{
    await ensureSession();

    const fd = new FormData();
    fd.append("prompt", ($("#prompt").value || "").toString());
    const f = $("#file").files[0]; if(f) fd.append("file", f);

    console.log("[UI] POST /profile", { sid, hasFile: !!f });
    const r = await fetch(`${ORCH}/profile/${encodeURIComponent(sid)}`, {
      method:"POST", body: fd, mode:"cors", cache:"no-store", credentials:"omit",
    });

    const bodyText = await r.text();
    let data={}; try{ data=JSON.parse(bodyText); }catch{}

    if(!r.ok){
      console.error("[UI] /profile failed", r.status, bodyText);
      setMsg("aMsg", `Profiling failed (HTTP ${r.status}). ${bodyText.slice(0,350)}`, "err");
      return;
    }

    fieldMap  = data.field_map || data.fieldMap || {};
    questions = data.questions || [];
    if(!fieldMap?.tables?.[0]?.fields?.length){
      setMsg("aMsg", "Profiling completed but no fields detected. Please check your file format.", "err");
    } else {
      setMsg("aMsg", "Profiling complete. Review fields and answer questions.", "ok");
    }
    renderFieldTable(fieldMap);
    renderQuestions(questions);
    show("stepB", true);
    $("#stepB").scrollIntoView({behavior:"smooth"});
  }catch(e){
    console.error(e);
    setMsg("aMsg", `Profiling failed. ${String(e)}`, "err");
  }finally{
    setBusy(btn, false);
  }
}
window._onStartClick = onProfileClick; // inline onclick fallback uses this

async function onDesignClick(){
  const btn = $("#toDesign");
  setBusy(btn, true, "Building…");
  setMsg("bMsg", "");
  try{
    await ensureSession();
    const fm = collectFieldMapEdits();
    const answers = collectAnswers();

    let r = await fetch(`${ORCH}/field-map/${encodeURIComponent(sid)}`, {
      method:"POST", headers:{'Content-Type':'application/json'}, body: JSON.stringify(fm),
      mode:"cors", cache:"no-store", credentials:"omit",
    });
    if(!r.ok){
      const t = await r.text().catch(()=>"(no body)");
      throw new Error(`/field-map failed (${r.status}): ${t}`);
    }

    r = await fetch(`${ORCH}/design/${encodeURIComponent(sid)}`, {
      method:"POST", headers:{'Content-Type':'application/json'},
      body: JSON.stringify({answers}), mode:"cors", cache:"no-store", credentials:"omit",
    });
    const text = await r.text(); let data={}; try{ data=JSON.parse(text); }catch{}
    if(!r.ok) throw new Error(`/design failed (${r.status}): ${text}`);
    if(!data.preview_url) throw new Error("No preview_url from /design");

    $("#preview").src = data.preview_url + (data.preview_url.includes("?") ? "&" : "?") + "_=" + Date.now();
    show("stepC", true);
    $("#stepC").scrollIntoView({behavior:"smooth"});
  }catch(e){ console.error(e); setMsg("bMsg", String(e), "err"); }
  finally{ setBusy(btn, false); }
}

async function onApplyNl(){
  const btn = $("#applyNl");
  setBusy(btn, true, "Applying…");
  setMsg("cMsg", "");
  try{
    await ensureSession();
    const r = await fetch(`${ORCH}/nl-edit/${encodeURIComponent(sid)}`, {
      method:"POST", headers:{'Content-Type':'application/json'},
      body: JSON.stringify({instruction: ($("#nl").value||"").toString()}),
      mode:"cors", cache:"no-store", credentials:"omit",
    });
    const text = await r.text(); let data={}; try{ data=JSON.parse(text); }catch{}
    if(!r.ok) throw new Error(`/nl-edit failed (${r.status}): ${text}`);
    if(data.preview_url){
      $("#preview").src = data.preview_url + (data.preview_url.includes("?") ? "&" : "?") + "_=" + Date.now();
    }
  }catch(e){ console.error(e); setMsg("cMsg", String(e), "err"); }
  finally{ setBusy(btn, false); }
}

async function onApprove(){
  try{
    await ensureSession();
    const email = ($("#email").value||"").trim();
    const company = ($("#company").value||"").trim();
    if(!email || !company){ alert("Company and email required"); return; }
    const r = await fetch(`${ORCH}/approve/${encodeURIComponent(sid)}`, {
      method:"POST", headers:{'Content-Type':'application/json'},
      body: JSON.stringify({company,email}), mode:"cors", cache:"no-store", credentials:"omit",
    });
    const text = await r.text(); let data={}; try{ data=JSON.parse(text); }catch{}
    if(!r.ok) throw new Error(`/approve failed (${r.status}): ${text}`);
    $("#plan").innerHTML = `<strong>${data.plan||"Plan"}</strong> – ${data.reason||""}<br>${
      data.signup_url ? `<a href="${data.signup_url}" target="_blank" rel="noopener">Continue to Sign Up</a>` : ""}`;
  }catch(e){ console.error(e); $("#plan").textContent = `Approval failed. ${String(e)}`; }
}

function onReloadPreview(){
  const src = $("#preview").src.split("&_=")[0];
  $("#preview").src = src + (src.includes("?") ? "&" : "?") + "_=" + Date.now();
}

/* ======== ALWAYS ATTACH HANDLERS ======== */
function attachHandlers(){
  $("#start")?.addEventListener("click", onProfileClick);
  $("#toDesign")?.addEventListener("click", onDesignClick);
  $("#applyNl")?.addEventListener("click", onApplyNl);
  $("#approve")?.addEventListener("click", onApprove);
  $("#downloadSpec")?.addEventListener("click", async () => {
    try{
      await ensureSession();
      const r = await fetch(`${ORCH}/artifacts?sid=${encodeURIComponent(sid)}`,
        {mode:"cors", cache:"no-store", credentials:"omit"});
      const data = await r.json();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `mr_draft_${sid}.json`;
      a.click();
    }catch(e){ console.error(e); alert("Could not download spec."); }
  });
  $("#reloadPreview")?.addEventListener("click", onReloadPreview);

  // Event-delegation fallback (if a theme re-renders the node)
  document.addEventListener("click", (ev) => {
    const t = ev.target;
    if (!t) return;
    if (t.id === "start") { ev.preventDefault(); onProfileClick(); }
  }, true);

  console.log("[UI] handlers attached");
}

/* ======== BOOT ======== */
document.addEventListener("DOMContentLoaded", async () => {
  try{
    attachHandlers();
    await ensureSession();
  }catch{}
});
</script>
</body>
</html>